server {
    listen 443;
    listen [::]:443;
    server_name www.paulfurley.com;

    root /var/www/www.paulfurley.com;

    ssl_certificate           /etc/letsencrypt/live/www.paulfurley.com/fullchain.pem;
    ssl_certificate_key       /etc/letsencrypt/live/www.paulfurley.com/privkey.pem;

    ssl on;

    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_prefer_server_ciphers on;
    ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH";
    ssl_ecdh_curve secp384r1; # Requires nginx >= 1.1.0
    ssl_session_cache shared:SSL:10m;

    # ssl_session_tickets off; # Requires nginx >= 1.5.9

    ssl_stapling on; # Requires nginx >= 1.3.7
    ssl_stapling_verify on; # Requires nginx => 1.3.7
    resolver 213.73.91.35 8.8.8.8 valid=300s;
    resolver_timeout 5s;

    # https://www.owasp.org/index.php/HTTP_Strict_Transport_Security
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload";

    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;

    # https://raymii.org/s/tutorials/Strong_SSL_Security_On_nginx.html#Logjam_(DH_EXPORT)
    ## To generate, run:                                                        
    ## $ sudo openssl dhparam -out /etc/ssl/certs/dhparam.pem 2048              
    ##  
    ssl_dhparam /etc/ssl/certs/dhparam.pem;  # LOGJAM and various others

    access_log            /var/log/nginx/www.paulfurley.com/access.log;
    error_log             /var/log/nginx/www.paulfurley.com/error.log;

    location ~* ^.+\.(css|js|png|jpg)$ {
        # Set css and js to expire in a very long time
        access_log off;
        expires 7d;
    }

    location = /apple-touch-icon.png { log_not_found off; }
    location = /apple-touch-icon-120x120-precomposed.png { log_not_found off; }
    location = /apple-touch-icon-120x120.png { log_not_found off; }
    location = /apple-touch-icon-precomposed.png { log_not_found off; }

    location = /wp-login.php {
       # also /phpmyadmin /admin/config.php /recordings/index.php /.git/HEAD

       # Run this as root:
       # dd if=/dev/zero bs=1M count=10240 | gzip > /var/www/zipbomb.gz

       # more_clear_headers Content-Length
       # add_header Content-Encoding: gzip;
       # add_header Content-Length 9420800;
       gzip_static always;
       # gzip_proxied expired no-cache no-store private auth;

       alias /var/www/zipbomb;
    }

    # Redirect rules
    rewrite ^/pgp$ https://www.paulfurley.com/309F635DAD1B5517.public.asc redirect;

    rewrite ^/wp-content/uploads/2012/02/picocolour_tn.jpg$ /img/picocolour-thumbnail.jpg permanent;
    rewrite ^/wp-content/uploads/2012/02/IMG_4428.jpg$ /img/arduinos-inside-ink-cabinet.jpg permanent;
    rewrite ^/wp-content/uploads/2013/02/Cooperative-Mobile-Robots-Paul-M-Furley.pdf$ /files/Cooperative-Mobile-Robots-Paul-M-Furley.pdf permanent;
    rewrite ^/wp-content/uploads/2013/02/cooperative-mobile-robots-paul-m-furley.pdf$ /files/Cooperative-Mobile-Robots-Paul-M-Furley.pdf permanent;
    rewrite ^/wp-content/uploads/2013/02/robot-white-background2.jpg$ /img/robot-white-background2.jpg permanent;
    rewrite ^/wp-content/uploads/2013/02/overview-of-communications.png$ /img/overview-of-communications.png permanent;
    rewrite ^/wp-content/uploads/2013/02/screenshot-system-running.png$ /img/screenshot-system-running.png permanent;
    rewrite ^/wp-content/uploads/2013/08/chilli_plant_stop_motion_video.jpg$ /img/chilli-plant-kit.jpg permanent;
    rewrite ^/wp-content/uploads/2013/08/chilli-cam-fswebcam.jpg$ /img/chilli-cam-fswebcam.jpg permanent;
    rewrite ^/wp-content/uploads/2013/08/samsung_n110_netbook.jpg$ /img/samsung-n110-netbook.jpg permanent;
    rewrite ^/wp-content/uploads/2013/10/Screenshot-from-2013-10-17-230813.png$ img/minute-mate-home-page.png permanent;
    rewrite ^/wp-content/uploads/2013/11/Screenshot-from-2013-10-17-225935.png$ /img/vodafone-online-login-screen.png permanent;
    rewrite ^/wp-content/uploads/2013/11/Vodafone-online-network-tab-screenshot.png$ /img/vodafone-online-network-tab-screenshot.png permanent;
    rewrite ^/wp-content/uploads/2014/08/Freecycle-too-many-emails.png$ /img/freecycle-too-many-emails.png permanent;
    rewrite ^/wp-content/uploads/2014/08/CloudMailin-email-forwarding-management-panel.png$ /img/cloudmailin-email-management-panel.png permanent;

    rewrite ^/wp-content/uploads/2014/08/Freecycle-filtering-sms-alert1.png$ /img/freecycle-sms-alert.png permanent;
    rewrite ^/wp-content/uploads/2014/10/internet-of-things-toaster.jpg$ /img/internet-of-things-toaster.jpg permanent;
    rewrite ^/wp-content/uploads/2014/10/inside-a-beautiful-straw-bale-house.jpg$ /img/inside-a-beautiful-straw-bale-house.jpg permanent;

    rewrite ^/gpg-for-humans-part-1-why-care-about-cryptography/$ /gpg-for-humans-why-care-about-cryptography/ permanent;
    rewrite ^/category/gpg-for-humans/$ /gpg-for-humans-why-care-about-cryptography/ permanent;
    rewrite ^/gpg-for-humans/$ /gpg-for-humans-why-care-about-cryptography/ permanent;

    rewrite ^/category/blog/$ /#blog permanent;
    rewrite ^/blog/$ /#blog permanent;

    rewrite ^/expirybot/?$ /expirybot-emails-pgp-users-before-their-key-expires/ redirect;

    # rewrite ^/wp-content/uploads/2013/02/baltic-creative-unit-51.jpg$
    # rewrite ^/wp-content/uploads/2013/11/Vodafone-online-network-tab-screenshot-1024x563.png$
    # rewrite ^/wp-content/uploads/2014/08/Freecycle-too-many-emails-1024x4651-620x180-1.png$
    # rewrite ^/wp-content/uploads/2013/11/PhantomJS-home-page-1024x420.png$
    # rewrite ^/wp-content/uploads/2013/10/Screenshot-from-2013-10-17-230813-300x256.png$
    # rewrite ^/wp-content/uploads/2013/10/Screenshot-from-2013-10-17-230813-300x2561-150x150.png$
    # rewrite ^/wp-content/uploads/2014/10/internet-of-things-toaster-1024x868.jpg$

    rewrite ^/feed/?$ https://www.paulfurley.com/feed.xml permanent;
}
