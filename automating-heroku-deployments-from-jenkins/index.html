<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <title>Automating our Heroku deployments from Jenkins</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width">
    <link type="application/atom+xml" rel="alternate" href="https://www.paulfurley.com/feed.xml" title="Paul Fawkesley, Engineer" />

    <!-- Font-Awesome -->
    <link rel="stylesheet" href="/css/vendor/font-awesome/font-awesome.min.css">

    <!-- Google Webfonts -->
    <link href="https://fonts.googleapis.com/css?family=Martel" rel="stylesheet">

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <!-- Styles -->
    <link rel="stylesheet" href="/css/site.css">

    <!--[if lt IE 9]>
        <script src="/js/vendor/google/html5-3.6-respond-1.1.0.min.js"></script>
    <![endif]-->

    <!-- Open Graph tags -->
    <meta property="og:site_name" content="www.paulfurley.com" />
    <meta property="og:title" content="Automating our Heroku deployments from Jenkins" />
    

    
      <meta content="At Sea Level Research we deploy to Heroku staging then production from Jenkins, with automatic database backups &amp; migrations. Read on to find out how.

Last week we released an early version of an API that we’re hosting with Heroku. We’re an early-stage startup and this is a component of our first product. At this point in our startup life, Heroku is a great fit as we need to focus on features, not infrastructure. We are targeting corporate customers with a pretty niche product, so we aren’t likely to suffer from massive overnight scaling issues.

Automating Heroku

I love Heroku, but I always find the command line deployment stuff a bit fiddly. How do I turn on maintenance mode again? How do I backup the database before I run the migrations? And given that I’m fanatical about automation - especially when it comes to deployment - it made sense to tackle our process from day one. If you don’t believe in automating deployment you might get some amusement reading Knightmare: a devops cautionary tale…

My wishlist of requirements went like this:


  I want a point-and-click deployment to Staging or Production - this must encapsulate all knowledge about how the deploy works.
  I want to automatically run database migrations.
  For staging deployments, I want to run the migrations against an exact copy of the production database to check we’re in sync.
  For production deployments, I want to backup the database before I run migrations, in case they bork it up.
  I want to put the app in and out of maintenance mode automatically.
  I want to make sure I’ve got at least one web worker running.
  I want this done from a Jenkins box with its own credentials.


One simple shell script

It turns out this is reasonably straightforward using Heroku’s command line client. In an afternoon I wrote up the following shell script which fulfills most of the above:

https://github.com/sealevelresearch/sea-level-api/blob/master/scripts/jenkins_deploy_to_heroku.sh

The most interesting bit is probably the use of the pgbackups Heroku add-on. During a staging deployment, the script instructs the backups module to backup production, then get a URL to its backup. It resets the staging database - rather than just overwriting rows - to ensure the schemas exactly match, then restores the production backup into staging. This means we have confidence that the subsequent database migrations are running against the actual database.

Configuring Jenkins

It turns out quite a large chunk of the work came about from configuring our Jenkins box to have the necessary tools, like the heroku command line client. For this we use the excellent Ansible, and we’ve had to make a fair few lightweight modules now such as ansible-heroku-toolbelt as ansible-jenkins.

None of this is rocket science, but I do believe that taking the time to implement this clean, conservative &amp; repeatable processes will be worth every penny six months down the line when I’m trying to push out a 2am bugfix for a major client…

Paul is CTO of Sea Level Research, a startup helping shipping ports to optimize their logistics.
" property="og:description">
    

    
      <meta content="article" property="og:type">
    

    <meta name="twitter:site" content="@fawkesley">


    <script>
      if(navigator.doNotTrack != "1") {
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-37077969-1', 'auto');
        ga('send', 'pageview');
      } else {
        console.debug("Respecting Do-Not-Track, not loading analytics. See https://www.paulfurley.com/google-analytics-dnt/");
      }
    </script>


</head>


<body>
    <header class="page-header">
      <div class="container">
        <a href="/" class="site-title">Paul Fawkesley</a>
      </div>
    </header>


<article class="blog-post container" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <time pubdate itemprop="datePublished" datetime="2014-07-02T00:00:00+00:00" content="2014-07-02T00:00:00+00:00">July 2014</time>
  </header>
	<span style="display: none" itemprop="author publisher" itemscope itemtype="http://schema.org/Person">
		<span itemprop="name">
			Paul Fawkesley
		</span>
	</span>

<h1 itemprop="headline">Automating our Heroku deployments from Jenkins</h1>

<p><em>At Sea Level Research we deploy to Heroku staging then production from Jenkins, with automatic database backups &amp; migrations. Read on to find out how.</em></p>

<p>Last week we released an early version of an API that we’re hosting with Heroku. We’re an early-stage startup and this is a component of our first product. At this point in our startup life, Heroku is a great fit as we need to focus on features, not infrastructure. We are targeting corporate customers with a pretty niche product, so we aren’t likely to suffer from massive overnight scaling issues.</p>

<h2 id="automating-heroku">Automating Heroku</h2>

<p>I love Heroku, but I always find the command line deployment stuff a bit fiddly. How do I turn on maintenance mode again? How do I backup the database before I run the migrations? And given that I’m fanatical about automation - especially when it comes to deployment - it made sense to tackle our process from day one. <em>If you don’t believe in automating deployment you might get some amusement reading <a href="http://dougseven.com/2014/04/17/knightmare-a-devops-cautionary-tale/" target="_blank">Knightmare: a devops cautionary tale</a>…</em></p>

<p>My wishlist of requirements went like this:</p>

<ul>
  <li>I want a point-and-click deployment to Staging or Production - this must encapsulate all knowledge about how the deploy works.</li>
  <li>I want to automatically run database migrations.</li>
  <li>For staging deployments, I want to run the migrations against an exact copy of the production database to check we’re in sync.</li>
  <li>For production deployments, I want to backup the database before I run migrations, in case they bork it up.</li>
  <li>I want to put the app in and out of maintenance mode automatically.</li>
  <li>I want to make sure I’ve got at least one web worker running.</li>
  <li>I want this done from a Jenkins box with its own credentials.</li>
</ul>

<h2 id="one-simple-shell-script">One simple shell script</h2>

<p>It turns out this is reasonably straightforward using Heroku’s command line client. In an afternoon I wrote up the following shell script which fulfills most of the above:</p>

<p><a href="https://github.com/sealevelresearch/sea-level-api/blob/master/scripts/jenkins_deploy_to_heroku.sh" target="_blank">https://github.com/sealevelresearch/sea-level-api/blob/master/scripts/jenkins_deploy_to_heroku.sh</a></p>

<p>The most interesting bit is probably the use of the <strong>pgbackups </strong>Heroku add-on. During a staging deployment, the script instructs the backups module to backup production, then get a URL to its backup. It <strong>resets</strong> the staging database - rather than just overwriting rows - to ensure the schemas exactly match, then restores the production backup into staging. This means we have confidence that the subsequent database migrations are running against the actual database.</p>

<h2 id="configuring-jenkins">Configuring Jenkins</h2>

<p>It turns out quite a large chunk of the work came about from configuring our Jenkins box to have the necessary tools, like the heroku command line client. For this we use the excellent <a href="http://www.ansible.com/home" target="_blank">Ansible</a>, and we’ve had to make a fair few lightweight modules now such as<a href="https://github.com/sealevelresearch/ansible-heroku-toolbelt" target="_blank"> ansible-heroku-toolbelt</a> as <a href="https://github.com/sealevelresearch/ansible-jenkins" target="_blank">ansible-jenkins</a>.</p>

<p>None of this is rocket science, but I do believe that taking the time to implement this clean, conservative &amp; repeatable processes will be worth every penny six months down the line when I’m trying to push out a 2am bugfix for a major client…</p>

<p><em><a href="https://twitter.com/fawkesley" target="_blank">Paul</a> is CTO of <a href="http://sealevelresearch.com" target="_blank">Sea Level Research</a>, a startup helping shipping ports to optimize their logistics.</em></p>


</article>



  <aside class="container related-blog-posts">
    <h3>Related</h3>
    <ul class="tales-list">
        
        
        <li><a href="/painless-merge-conflicts-in-git/">
          Painless merge conflicts in Git
        </a></li>
        
        
        
        
    </ul>
  </aside>


  <footer class="page-footer">
    <div class="container">
      <div class="row">
        <div class="col-half">

          <h3> <i class="fa fa-star"></i> Highlights</h3>
          <ul class="tales-list">
            <li><a href="https://www.fluidkeys.com">PGP Software for Teams: Fluidkeys</a></li>
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            <li><a href="/randomize-your-wifi-mac-address-on-ubuntu-1604-xenial/">Randomize your WiFi MAC address on Ubuntu 16.04</a></li>
            
            
            
            
            
            <li><a href="/expirybot-emails-pgp-users-before-their-key-expires/">Expirybot emails PGP users before their key expires</a></li>
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            <li><a href="/building-software-users-love/">Building Software Users Love</a></li>
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            <li><a href="/resisting-the-urge-to-build/">Resisting the Urge to Build</a></li>
            
            
            
            
            
            
            
            <li><a href="/arduino-isnt-just-for-hackers/">Arduino Isn't Just For Hackers</a></li>
            
            
            
            
            
            
            
            
            
            
            
            
            
            
          </ul>
        </div>

        <div class="col-half">
          <a id="contact"></a>
          <h3> <i class="fa fa-envelope"></i> Contact Me</h3>

          <p>Feedback, freelancing, ideas or anything else, <a href="/contact/">drop me a line.</a></p>

	  <p>PGP: <a href="/pgp">A999 B749 8D1A 8DC4 73E5  3C92 309F 635D AD1B 5517</a></p>
          <p>Mastodon: <a rel="me" href="https://mastodon.me.uk/@paul">paul@mastodon.me.uk</a></p>

          <a href="http://www.drupalhandboek.nl/moralecompensation.php?s=937"><div style="height: 0px; width: 0px;"></div></a>


        </div>
      </div>
    </div>
  </footer>

</body>

</html>

